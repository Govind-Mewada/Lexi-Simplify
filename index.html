<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lexi-Simplify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .drag-drop-zone {
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            transition: all 0.2s ease-in-out;
        }
        .drag-drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #e0f2fe;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-4xl p-8 transform transition-all duration-300 ease-in-out">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight mb-2">Lexi-Simplify</h1>
            <p class="text-gray-600 font-medium">Demystify Legal Documents with AI</p>
        </div>

        <!-- Disclaimer and Info -->
        <div id="disclaimer" class="bg-yellow-50 text-yellow-800 rounded-lg p-4 mb-6 text-sm">
            <p class="font-semibold">Disclaimer:</p>
            <p>This tool is for informational purposes only and is not a substitute for professional legal advice. Please consult with a qualified legal professional for any legal concerns.</p>
        </div>

        <div class="space-y-6">
            <!-- Document Input Area -->
            <div>
                <label for="document-text" class="block text-sm font-medium text-gray-700 mb-2">Paste or Upload your legal document:</label>
                <div id="drag-drop-area" class="drag-drop-zone rounded-lg p-6 text-center mb-4 cursor-pointer">
                    <p class="text-gray-500 font-medium">Drag and drop a file here</p>
                    <p class="text-sm text-gray-400 mt-1">or</p>
                    <label class="cursor-pointer bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-blue-200 mt-2 inline-block">
                        <input type="file" id="document-file" accept=".txt,.json,.html,.md,.pdf,.docx" class="hidden">
                        Select a file to upload
                    </label>
                    <span id="file-name" class="block text-gray-500 text-sm mt-2">No file chosen</span>
                </div>
                <textarea id="document-text" rows="12" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200 p-4 text-gray-800" placeholder="Or, paste your legal document here..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="summarize-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                    <span id="summarize-text">Summarize Document</span>
                    <span id="summarize-loader" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></span>
                </button>
            </div>

            <!-- Question Input Area -->
            <div>
                <label for="question-text" class="block text-sm font-medium text-gray-700 mb-2">Ask a question about the document:</label>
                <input type="text" id="question-text" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200 p-4 text-gray-800" placeholder="e.g., What are my responsibilities as a tenant?">
                <button id="ask-btn" class="w-full mt-4 bg-gray-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200">
                    <span id="ask-text">Ask</span>
                    <span id="ask-loader" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></span>
                </button>
            </div>
            
            <!-- Output Area -->
            <div id="output-area" class="bg-gray-50 rounded-lg p-6 shadow-inner text-gray-800 transition-all duration-300 ease-in-out hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-4">AI Response:</h3>
                <div id="output-content" class="prose max-w-none"></div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const documentTextarea = document.getElementById('document-text');
            const documentFile = document.getElementById('document-file');
            const fileNameSpan = document.getElementById('file-name');
            const summarizeBtn = document.getElementById('summarize-btn');
            const summarizeText = document.getElementById('summarize-text');
            const summarizeLoader = document.getElementById('summarize-loader');
            const questionInput = document.getElementById('question-text');
            const askBtn = document.getElementById('ask-btn');
            const askText = document.getElementById('ask-text');
            const askLoader = document.getElementById('ask-loader');
            const outputArea = document.getElementById('output-area');
            const outputContent = document.getElementById('output-content');
            const dragDropArea = document.getElementById('drag-drop-area');

            const API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
            const apiKey = "AIzaSyBswQeyzsv7lXwu6nD-6S7SEIOpwLgyH8s"; // Canvas will provide this in the runtime

            // Drag and drop events
            dragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragDropArea.classList.add('dragover');
            });

            dragDropArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragDropArea.classList.remove('dragover');
            });

            dragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragDropArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    documentFile.files = files;
                    documentFile.dispatchEvent(new Event('change'));
                }
            });

            documentFile.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    fileNameSpan.textContent = 'No file chosen';
                    return;
                }
                fileNameSpan.textContent = file.name;

                const mimeType = file.type;
                if (!['text/plain', 'text/html', 'application/json', 'text/markdown', 'application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(mimeType)) {
                    alert('Unsupported file type. Please upload a .txt, .json, .html, .md, .pdf, or .docx file.');
                    documentTextarea.value = '';
                    fileNameSpan.textContent = 'No file chosen';
                    return;
                }

                if (['text/plain', 'text/html', 'application/json', 'text/markdown'].includes(mimeType)) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        documentTextarea.value = e.target.result;
                    };
                    reader.onerror = () => {
                        documentTextarea.value = 'Failed to read file.';
                    };
                    reader.readAsText(file);
                } else {
                    // For PDF and DOCX, we send the file directly to the API
                    // so we clear the textarea and don't populate it with binary data.
                    documentTextarea.value = `File uploaded: ${file.name}. Click 'Summarize Document' or ask a question.`;
                }
            });

            async function callGeminiAPI(prompt, file) {
                const parts = [{ text: prompt }];
                
                if (file && ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type)) {
                    const base64Promise = new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64String = reader.result.split(',')[1];
                            resolve(base64String);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    const base64Data = await base64Promise;
                    
                    parts.push({
                        inlineData: {
                            mimeType: file.type,
                            data: base64Data
                        }
                    });
                } else {
                    parts.push({
                        text: documentTextarea.value.trim()
                    });
                }

                const payload = {
                    contents: [{
                        parts: parts
                    }]
                };

                const requestOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                };

                try {
                    let response;
                    let retries = 3;
                    while (retries > 0) {
                        response = await fetch(`${API_ENDPOINT}?key=${apiKey}`, requestOptions);
                        if (response.status === 429) { // Too Many Requests
                            const delay = Math.pow(2, 3 - retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries--;
                        } else {
                            break;
                        }
                    }

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`API Error: ${response.status} - ${JSON.stringify(error)}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || "No response from the model.";

                } catch (error) {
                    console.error('API call failed:', error);
                    return "Sorry, I couldn't process that. Please try again or check the document.";
                }
            }

            // Function to handle the summarization request
            summarizeBtn.addEventListener('click', async () => {
                const documentText = documentTextarea.value.trim();
                const file = documentFile.files[0];
                if (!documentText && !file) {
                    alert('Please paste or upload a legal document to summarize.');
                    return;
                }

                showLoading(summarizeBtn, summarizeText, summarizeLoader);
                outputArea.classList.add('hidden');

                const prompt = `Please act as a legal document simplifier. I will provide you with a legal document. Your task is to summarize the document in a concise and easy-to-understand manner, using simple language. Do not use legal jargon. Highlight the key responsibilities, rights, and potential risks for the user.`;
                
                const responseText = await callGeminiAPI(prompt, file);

                hideLoading(summarizeBtn, summarizeText, summarizeLoader);
                displayOutput(responseText);
            });

            // Function to handle the question request
            askBtn.addEventListener('click', async () => {
                const documentText = documentTextarea.value.trim();
                const questionText = questionInput.value.trim();
                const file = documentFile.files[0];


                if (!documentText && !file) {
                    alert('Please paste or upload a legal document first.');
                    return;
                }
                if (!questionText) {
                    alert('Please enter your question.');
                    return;
                }

                showLoading(askBtn, askText, askLoader);
                outputArea.classList.add('hidden');

                const prompt = `Based on the following legal document, please answer the user's question clearly and simply. If the document does not contain the answer, please state that. Do not guess.\n\nUser Question:\n${questionText}`;

                const responseText = await callGeminiAPI(prompt, file);

                hideLoading(askBtn, askText, askLoader);
                displayOutput(responseText);
            });

            function showLoading(button, textElement, loaderElement) {
                textElement.classList.add('hidden');
                loaderElement.classList.remove('hidden');
                button.disabled = true;
            }

            function hideLoading(button, textElement, loaderElement) {
                textElement.classList.remove('hidden');
                loaderElement.classList.add('hidden');
                button.disabled = false;
            }

            function displayOutput(text) {
                outputContent.innerHTML = formatMarkdown(text);
                outputArea.classList.remove('hidden');
            }

            function formatMarkdown(text) {
                let html = text
                    .replace(/###\s(.+)/g, '<h3>$1</h3>')
                    .replace(/##\s(.+)/g, '<h2>$1</h2>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/^- (.+)/g, '<li>$1</li>');
                
                const lines = html.split('\n');
                let inList = false;
                let formattedLines = lines.map(line => {
                    if (line.trim().startsWith('<li>')) {
                        if (!inList) {
                            inList = true;
                            return `<ul>${line}`;
                        }
                        return line;
                    } else {
                        if (inList) {
                            inList = false;
                            return `</ul>${line}`;
                        }
                        return line;
                    }
                });
                if (inList) {
                    formattedLines.push('</ul>');
                }
                html = formattedLines.join('\n');

                return html;
            }

        });
    </script>

</body>
</html>
